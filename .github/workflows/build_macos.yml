name: Build macOS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - master
      version:
        description: 'Version tag for release (e.g. mac_v1.0.0)'
        required: false
        default: ''
        type: string
      upload_release:
        description: 'Upload to GitHub Release'
        required: true
        default: true
        type: boolean

  push:
    tags:
      - 'mac_v*'

concurrency:
  group: macos-release
  cancel-in-progress: true

jobs:
  build-macos:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/heads/{0}', github.event.inputs.branch) || github.ref }}
          fetch-depth: 0

      # -------------------------
      # Flutter environment
      # -------------------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.x'
          cache: true

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Flutter doctor
        run: flutter doctor -v

      # -------------------------
      # Dependencies
      # -------------------------
      - name: Restore packages
        working-directory: simple_live_app
        run: flutter pub get

      - name: Install flutter_distributor
        run: |
          dart pub global activate flutter_distributor ^0.4.6
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # -------------------------
      # Build
      # -------------------------
      - name: Build macOS (dmg + zip)
        working-directory: simple_live_app
        run: |
          flutter_distributor package \
            --platform macos \
            --targets dmg,zip \
            --skip-clean

      # -------------------------
      # Artifacts
      # -------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macOS-${{ github.run_number }}
          path: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      # -------------------------
      # Version resolve
      # -------------------------
      - name: Resolve version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=mac_dev_$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          fi

      - name: Echo version
        run: echo "Version ${{ steps.version.outputs.VERSION }}"

      # -------------------------
      # Release
      # -------------------------
      - name: Upload to GitHub Release
        if: |
          github.event_name == 'push' ||
          github.event.inputs.upload_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: macOS ${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'dev') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') }}
          files: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------
      # Done
      # -------------------------
      - name: Build completed
        run: echo "üçè macOS build finished with status ${{ job.status }}"
